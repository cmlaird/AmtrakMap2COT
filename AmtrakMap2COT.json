const trains = msg.payload;

const ICONSET_UID = "ad78aafb-83a6-4c07-b2b9-a897a8b6a38f";
const ICON_NAME = "rail.png";

// Thresholds in minutes
const LATE_MIN = 5;
const VERY_LATE_MIN = 30;
const EXTREMELY_LATE_MIN = 60;

const COLORS = {
    Green:  "-16711936",
    Yellow: "-256",
    Red:    "-65536",
    Black:  "-16777216",
    Gray:   "-8355712"
};

function nowCot() {
    return new Date().toISOString().replace(/\.\d{3}Z/, '.0Z');
}

function staleCot(seconds = 120) {
    return new Date(Date.now() + seconds * 1000).toISOString().replace(/\.\d{3}Z/, '.0Z');
}

function getVarianceFromAlert(alerts) {
    if (!alerts || alerts.length === 0) return null;
    const latest = alerts[alerts.length - 1].text;
    const match = latest.match(/approximately (\d+) minutes? late/i);
    return match ? parseInt(match[1]) : null;
}

function getCurrentVariance(stops) {
    // Walk through all stops and grab the last ACTUAL departure variance
    let lastActualVariance = null;
    for (const stop of stops) {
        if (stop.depart && stop.depart.type === "ACTUAL") {
            lastActualVariance = stop.depart.variance;
        }
    }
    if (lastActualVariance !== null) return lastActualVariance;

    // Fall back to the next ESTIMATED stop
    const now = Date.now() / 1000;
    const nextEstimated = stops.find(s =>
        !s.canceled &&
        s.depart &&
        s.depart.type === "ESTIMATED" &&
        s.sched_depart > now
    );
    if (nextEstimated) return nextEstimated.depart.variance;

    return 0;
}

function getNextStop(stops) {
    const now = Date.now() / 1000;
    const next = stops.find(s =>
        !s.canceled &&
        s.depart &&
        s.depart.type === "ESTIMATED" &&
        s.sched_depart > now
    );
    if (!next) return null;

    const variance = next.depart.variance;
    const absMin = Math.abs(Math.round(variance / 60));
    const status = variance > 0
        ? `${absMin} min late`
        : variance < 0
        ? `${absMin} min early`
        : `on time`;

    return { code: next.code, status };
}

function getColorName(disruption, varianceMin) {
    if (disruption) return "Gray";
    if (varianceMin >= EXTREMELY_LATE_MIN) return "Black";
    if (varianceMin >= VERY_LATE_MIN) return "Red";
    if (varianceMin >= LATE_MIN) return "Yellow";
    return "Green";
}

const cotEvents = trains
    .filter(t => t.location)
    .map(t => {
        const { latitude, longitude, heading, speed } = t.location;
        const speedMs = (speed * 0.44704).toFixed(2);
        const uid = `TRAIN-${t.train_id}`;
        const callsign = `${t.number} - ${t.name}`;

        const stops = t.stops || [];

        // Use alert-derived minutes if available, fall back to variance calculation
        const alertVarianceMin = getVarianceFromAlert(t.alerts);
        const varianceMin = alertVarianceMin !== null
            ? alertVarianceMin
            : Math.round(getCurrentVariance(stops) / 60);

        const nextStop = getNextStop(stops);
        const colorName = getColorName(t.disruption, varianceMin);
        const argb = COLORS[colorName];

        const latestAlert = t.alerts && t.alerts.length > 0
            ? t.alerts[t.alerts.length - 1].text
            : null;

        const remarks = [
            `${t.origin} â†’ ${t.destination}`,
            `Speed: ${speed} mph`,
            nextStop ? `Next Stop: ${nextStop.code} (${nextStop.status})` : null,
            t.disruption ? `âš  DISRUPTION REPORTED` : null,
            latestAlert ? `ðŸš¨ ${latestAlert}` : null
        ].filter(Boolean).join(" | ");

        return `<event version="2.0" uid="${uid}" type="a-f-G-E-V-T" time="${nowCot()}" start="${nowCot()}" stale="${staleCot()}" how="m-g">` +
            `<point lat="${latitude}" lon="${longitude}" hae="9999999.0" ce="9999999.0" le="9999999.0"/>` +
            `<detail>` +
                `<contact callsign="${callsign}"/>` +
                `<track course="${heading}" speed="${speedMs}"/>` +
                `<remarks>${remarks}</remarks>` +
                `<usericon iconsetpath="${ICONSET_UID}/Shapes/${ICON_NAME}"/>` +
                `<color argb="${argb}"/>` +
            `</detail>` +
        `</event>`;
    });

msg.payload = cotEvents;
return msg;
